"""
Drawing up an NHI Mh relation using Gelli's paper
https://ui.adsabs.harvard.edu/abs/2025arXiv251001315G/abstract
"""

import os

import numpy as np
import py21cmfast as p21c

from tqdm import tqdm

from astropy.cosmology import Planck18, z_at_value
from astropy import units as u
from astropy.constants import c, k_B, m_p, e, m_e

from scipy.special import gamma, erf
from scipy.optimize import curve_fit, differential_evolution

import matplotlib.pyplot as plt
rc = {"font.family" : "serif", 
    "mathtext.fontset" : "stix"}
plt.rcParams.update(rc) 
plt.rcParams["font.serif"] = ["Times New Roman"] + plt.rcParams["font.serif"]
plt.rcParams.update({'font.size': 14})
import matplotlib as mpl
label_size = 20
font_size = 30
mpl.rcParams['xtick.labelsize'] = label_size 
mpl.rcParams['ytick.labelsize'] = label_size

plt.style.use('dark_background')

mh = [9.79045995503466, 9.875638783112809, 10.08517882807815, 10.110732492098313, 10.163543449729046, 10.173764915337111, 10.081771724864524, 10.120953957706378, 10.18228275135477, 10.281090304221799, 10.308347597832368, 10.18909711374921, 10.354344193068663, 10.41226572753624, 10.374787124284794, 10.441226650737217, 10.449744486754877, 10.497444711581577, 10.553662772425938, 10.591141375677385, 10.5315162116194, 10.626916505305614, 10.686541825330787, 10.889267507901687, 10.931856999924356, 10.965928499962178, 10.974446335979836, 10.773424282999343, 10.776831386212969, 10.643952333308118, 10.68483819574038, 10.764906291014496, 10.785349222230627, 10.778535015803376, 10.81771724864523, 10.86712094709515, 10.873935309489589, 10.942078465532422, 10.592845005267792, 10.764906291014496, 10.822827981449263, 10.873935309489589, 10.916524801512258, 10.96422487037177, 10.868824576685556, 11.023850190396944, 11.09028971684937, 11.088586087258962, 11.09028971684937, 11.008517991984846, 11.069846785633239, 11.059625320025173, 11.051107328040327, 11.095400449653402]
sigma = [0.8123732677174494, 0.67849903665359, 0.9361054806286127, 0.942190672949697, 0.9239350959864436, 0.8630831727755983, 0.6622717333271433, 0.6582150003481975, 0.5953346177952135, 0.9665314422340351, 0.9726166345551197, 1.2423934631723115, 0.7738336544488034, 0.7434076928433807, 0.6582150003481975, 0.8793103832493789, 0.980730193365677, 0.7839755797488335, 0.8346855776596486, 0.7880324984331113, 0.5385396132686459, 0.5466530792265372, 0.5567951902318995, 0.5040567329789456, 0.5851926924951832, 0.6338742310638593, 0.6602434596903364, 0.6237323057638291, 0.6906694212957589, 0.7494928851644653, 0.8468559623018175, 0.8569979804545138, 0.9665314422340351, 0.9847870191972887, 0.9198782701548318, 0.9482758652707817, 0.8509127881334294, 0.8062880753963646, 1.2383367301933657, 1.236308270851227, 1.2464502890039233, 1.12271807609276, 1.2018255762668586, 1.1186612502611482, 1.1490872118665707, 0.9300202883075281, 0.9401623064602243, 1.045638942408134, 1.1774848069825206, 1.2018255762668586, 1.2464502890039233, 1.3985800970310363, 1.5770790408319602, 1.8732250980756286]

def linear_func(x, a, b):
    """
    Linear function.
    """
    return a * x + b

popt, pcov = curve_fit(linear_func, mh, sigma)
print("Fitted linear parameters for sigma(Mh):", popt)

plt.plot(mh, sigma, 'o', label='Data')
plt.plot(mh, linear_func(np.array(mh), *popt), '-', label='Fitted line')
plt.xlabel(r'$\log_{10}(M_{\rm h}/M_\odot)$', fontsize=font_size)
plt.ylabel(r'$\sigma_{\log_{10}{M_{\rm h}}}$', fontsize=font_size)
# plt.legend()
plt.show()

# opt parameters
# 0.29122122 -2.17973027